name: Test

on: [push, pull_request]

jobs:
  test:
    strategy:
      matrix:
        go: ['1.17.x', '1.18.x']
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up the prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu qemu-user

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: ${{ matrix.go }}

    - name: Test
      run: |
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v fmt"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v internal/abi"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v internal/cpu"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v internal/fmtsort"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v internal/itoa"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v internal/reflectlite"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v internal/unsafeheader"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v math"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v math/big"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v math/bits"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v math/cmplx"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v math/rand"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v -test.short runtime"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v runtime/debug"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v runtime/internal/atomic"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v runtime/internal/math"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v runtime/internal/sys"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v strconv"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v strings"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v sort"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v sync"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v sync/atomic"
        GOARCH=arm64 go run test.go -qemu -args="-test.run=^Test -test.v time"
